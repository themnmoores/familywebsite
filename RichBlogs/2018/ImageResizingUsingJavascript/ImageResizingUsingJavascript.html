<!doctype html>
<html>

<head>
<script src="../../../formatting.js"></script>

<meta name="viewport" content="width=1200">

<meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">ol{margin:0;padding:0}table td,table th{padding:0}.c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:12pt;font-family:"Arial";font-style:normal}.c0{margin-left:36pt;padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c12{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Arial";font-style:normal}.c8{color:#999999;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Arial";font-style:normal}.c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c1{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c10{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:center}.c4{text-decoration-skip-ink:none;font-size:12pt;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c13{background-color:#ffffff;max-width:540pt;padding:36pt 36pt 36pt 36pt}.c11{color:#999999;font-size:10pt}.c7{color:inherit;text-decoration:inherit}.c9{font-weight:700}.c5{height:11pt}.c6{font-size:12pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style>

<script>addGoogleAnalytics();</script>

<meta name="description" content="Resizing of image files using a HTML5 Canvas in Javascript">
<meta name="keywords" content="Javascript, Image Resizing, JPEG, HTML5 Canvas">

</head><body style="padding:0 0 0 0;max-width:100vw" onload="setVerticalPositionToSpan()" class="c13">

<script>setBodyBackgroundFormatting();</script>
<div id="headerTopBar"></div>
<script>commonPageHeaderBarNew2("","../../../");</script>
<script>commonNavivationButtonsNew2("../../../","");</script>

<div style="text-align:center;margin-top:3vw" >

<div style="width:612pt;margin-left: auto;margin-right: auto;">

<p class="c10"><span class="c12">Image Resizing Using Javascript</span></p><p class="c10"><span class="c12">January 24, 2018</span></p><p class="c10"><span class="c12">Richard Moore</span></p><p class="c1 c5"><span class="c2"></span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1"><span class="c6">In my </span><span class="c4"><a class="c7" href="http://themnmoores.net/RichBlogs/2017/JavascriptPhotoViewer/JavascriptPhotoViewer.html">blog post </a></span><span class="c3">about a JavaScript based photo slideshow viewer, I mentioned creating a utility for the bulk resizing of image files using JavaScript. Here is a write up of how I used the HTML5 Canvas element from JavaScript code to resize image files and create new JPEG files of the resized images. To make things easy for myself the image files to be resized must be contained in a single zip archive. The resized images are placed as JPEG files, regardless of the original format, back into the zip archive (overwriting the original file) and downloaded to the users computer. The HTML and JavaScript code is contained in the files:</span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1"><span class="c6">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4"><a class="c7" href="http://themnmoores.net/ResizePhotoZip/resizePhotoZip.html">resizePhotoZip.html</a></span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1"><span class="c6">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4"><a class="c7" href="http://themnmoores.net/ResizePhotoZip/resizePhotoZip.js">resizePhotoZip.js</a></span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1"><span class="c6">If you look at the JavaScript file you can see that there is not a lot of code. It turns out to be pretty easy to do this. I leveraged </span><span class="c4"><a class="c7" href="https://stuk.github.io/jszip/">JSZip</a></span><span class="c6">&nbsp;and </span><span class="c4"><a class="c7" href="https://github.com/eligrey/FileSaver.js/">FileSaver.js</a></span><span class="c3">&nbsp;as I have in other JavaScript projects.</span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1"><span class="c3">The HTML sets up a minimal user interface as show below, and also pulls in the needed JavaScript files.</span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 720.00px; height: 244.00px;"><img alt="" src="images/image2.png" style="width: 720.00px; height: 405.00px; margin-left: 0.00px; margin-top: -14.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span><span class="c3">&nbsp; &nbsp; </span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1"><span class="c3">The user can set the desired resized image width and height along with a JPEG quality value for use in saving the resized image data to a JPEG file. Once a zip file that contains the image files to resize is selected, the files are processed one at a time and displayed on the screen in the canvas (which is the element used for resizing). I was pretty impressed how fast the JavaScript processes through the files, and how big a zip file you can process. There is no effort made to recover from errors associated with bad image files or files that may be in the zip archive that are not image files. Things just stop processing and no result zip file downloaded with no notice that anything went wrong. I might spend some time fixing this in the future, but for what I am doing it works well enough. As you can see below, the resulting zip file of resized JPEG files is downloaded as resizedImages.zip. The browser download process automatically takes care of any conflicts in file names.</span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 720.00px; height: 360.00px;"><img alt="" src="images/image1.png" style="width: 720.00px; height: 405.00px; margin-left: 0.00px; margin-top: -19.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1"><span class="c3">When a zip archive is selected, the JavaScript callback code gets the user configured parameters for the resize width, height, and JPEG quality. A FileReader is then set up to load the zip archive for JSZip to use.</span></p><p class="c1 c5"><span class="c3"></span></p><p class="c0"><span class="c8">function StartImagesZipResize() {<br> &nbsp;if (!XMLHttpRequest) {<br> &nbsp; &nbsp; &nbsp;alert(&quot;XMLHttpRequest not supported!!!!&quot;);<br> &nbsp; &nbsp; &nbsp;return;<br> &nbsp;}<br> &nbsp;var files = document.getElementById(&#39;zipFile&#39;).files;<br> &nbsp;if (files.length === 0) {<br> &nbsp; &nbsp; &nbsp;alert(&quot;No files to upload!!!!&quot;);<br> &nbsp; &nbsp; &nbsp;return;<br> &nbsp;}<br> &nbsp;var file = files[0];<br> &nbsp;imageUploaded = 0;<br> &nbsp;document.getElementById(&#39;currentFileProcessing&#39;).innerHTML = &quot;Processing File: &quot; + file.name;<br><br> &nbsp;currentFileNumber = 0;<br> &nbsp;fileNames = undefined;<br> &nbsp;zipArchiveToReadFrom = undefined;<br><br> &nbsp;// Get the size and jpeg quality<br> &nbsp;resizeTargetWidth = document.getElementById(&#39;resizePhotoZipWidth&#39;).value;<br> &nbsp;resizeTargetHeight = document.getElementById(&#39;resizePhotoZipHeight&#39;).value;<br> &nbsp;jpegQuality = document.getElementById(&#39;resizePhotoZipJPEGQuality&#39;).value / 100.0;<br> &nbsp; &nbsp;<br> &nbsp;var reader = new FileReader();<br> &nbsp;reader.onloadend = ReadOfArchiveFileCompleted;<br> &nbsp;reader.readAsArrayBuffer(file);<br>}<br></span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1"><span class="c6">When the FileReader has loaded the zip archive the </span><span class="c6 c9">ReadOfArchiveFileCompleted</span><span class="c3">&nbsp;callback is called to continue processing.</span></p><p class="c1 c5"><span class="c2"></span></p><p class="c0"><span class="c8">function ReadOfArchiveFileCompleted(evt)<br>{<br> &nbsp;theResizeCanvas = document.getElementById(&quot;themnmooresResizeCanvas&quot;);<br> &nbsp;theResizeCanvas.width = resizeTargetWidth;<br> &nbsp;theResizeCanvas.height = resizeTargetHeight;<br> &nbsp;<br> &nbsp;var imagesZipFile = new JSZip();<br> &nbsp;imagesZipFile.loadAsync(evt.target.result)<br> &nbsp;.then(function success(zip)<br> &nbsp;{<br> &nbsp; &nbsp;console.log(&#39;Read zip file&#39;);<br> &nbsp; &nbsp;zipArchiveToReadFrom = zip;<br> &nbsp; &nbsp;fileNames = zip.file(/./); &nbsp; &nbsp;<br> &nbsp; &nbsp;// Kick off the async chain of callbacks for processing an image<br> &nbsp; &nbsp;startProcessingFile(fileNames[0].name);<br> &nbsp;});<br>}<br></span></p><p class="c0 c5"><span class="c8"></span></p><p class="c1"><span class="c6">The HTML canvas element is set to the appropriate width and height (this could have been done in the previous function), and then JSZip is used to load the zip file for JavaScript to use. The process of resizing each individual file is started by calling </span><span class="c9 c6">startProcessingFile</span><span class="c3">.</span></p><p class="c1 c5"><span class="c2"></span></p><p class="c0"><span class="c8">function startProcessingFile(name)<br>{<br> &nbsp;// Read the file from the zip archive<br> &nbsp;theFile = zipArchiveToReadFrom.file(name);<br> &nbsp;theFile.async(&#39;blob&#39;)<br> &nbsp;.then(function success(content)<br> &nbsp;{<br> &nbsp; &nbsp;// Resize the image file into a canvas<br> &nbsp; &nbsp;currentImage = new Image();<br> &nbsp; &nbsp;content.type = &#39;image/jpeg&#39;;<br> &nbsp; &nbsp;currentImage.src = URL.createObjectURL(content);<br> &nbsp; &nbsp;currentImage.onload = resizeImage;<br> &nbsp; &nbsp;<br> &nbsp;},<br> &nbsp;function error(e){<br> &nbsp; &nbsp;document.getElementById(&#39;archiveFileContents&#39;).innerHTML = &#39;&lt;br&gt;&lt;br&gt;&lt;b&gt;ERROR reading zip file: &lt;/b&gt;:&#39; + e;<br> &nbsp; &nbsp;console.log(&#39;ERROR reading zip file:&#39; + e);<br> &nbsp;}); &nbsp;<br>}<br></span></p><p class="c1 c5"><span class="c2"></span></p><p class="c1"><span class="c6">This function reads the image file from the zip archive and sets up for the image to be rendered on the html canvas using an Image object that calls the function </span><span class="c9 c6">resizeImage</span><span class="c3">&nbsp;when the image file data is loaded and ready to be used.</span></p><p class="c1 c5"><span class="c2"></span></p><p class="c0"><span class="c8">function resizeImage()<br>{<br> &nbsp;ctx = theResizeCanvas.getContext(&quot;2d&quot;);<br><br> &nbsp;// Figure out how to fit the image to the desired size restrictions<br> &nbsp;scaleFactorX = resizeTargetWidth / currentImage.width;<br> &nbsp;scaleFactorY = resizeTargetHeight / currentImage.height;<br> &nbsp;width = resizeTargetWidth;<br> &nbsp;height = resizeTargetHeight;<br> &nbsp;if (scaleFactorX &lt; scaleFactorY) &nbsp; &nbsp; &nbsp;// Means the x dimension gets scaled more<br> &nbsp;{<br> &nbsp; &nbsp;height = currentImage.height * scaleFactorX;<br> &nbsp;}<br> &nbsp;else &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Means the y dimension gets scaled more<br> &nbsp;{<br> &nbsp; &nbsp;width = currentImage.width * scaleFactorY; &nbsp; &nbsp;<br> &nbsp;}<br> &nbsp;theResizeCanvas.width = width;<br> &nbsp;theResizeCanvas.height = height;<br> &nbsp; &nbsp;<br> &nbsp;ctx.drawImage(currentImage, 0, 0, width, height);<br> &nbsp;<br> &nbsp;// Now create a jpeg image from canvas<br> &nbsp;var canvasJpegBlob = theResizeCanvas.toBlob(jpegBlobCallback,&#39;image/jpeg&#39;, jpegQuality);<br>}</span></p><p class="c0 c5"><span class="c8"></span></p><p class="c1"><span class="c6">The image aspect ratio is preserved when scaling so we figure out a scaling factor that will preserve the aspect ratio while fitting the image data into the width/height dimensions specified by the user. This scaling factor is used to calculate the width and height for the canvas element to be set to for scaling the image properly. Image data is then rendered with resizing to the canvas using the </span><span class="c9 c6">drawImage</span><span class="c6">&nbsp;function of the canvas. The canvas is then converted to a JPEG file blob which is written to the existing zip archive overwriting the existing image file. The canvas </span><span class="c9 c6">toBlob</span><span class="c6">&nbsp;function calls </span><span class="c9 c6">jpegBlobCallbac</span><span class="c3">k to write the blob back into the zip archive.</span></p><p class="c1 c5"><span class="c3"></span></p><p class="c0"><span class="c8">function jpegBlobCallback(blobObj)<br>{<br> &nbsp;// Replace the modified jpeg into the zip file (overwritting the existing one)<br> &nbsp;zipArchiveToReadFrom.file(fileNames[currentFileNumber].name,blobObj); &nbsp; &nbsp;<br> &nbsp;nextImage();<br>}<br></span></p><p class="c1"><span class="c6">Once the file is written into the zip archive the </span><span class="c9 c6">nextImage</span><span class="c3">&nbsp;function is called to repeat the process above for the next image file.</span></p><p class="c1 c5"><span class="c2"></span></p><p class="c0"><span class="c11">function nextImage()<br>{<br> &nbsp;currentFileNumber++;<br> &nbsp;if (currentFileNumber &lt; fileNames.length)<br> &nbsp;{<br> &nbsp; &nbsp; &nbsp;// Kick off the async chain of callbacks for processing an image<br> &nbsp; &nbsp;startProcessingFile(fileNames[currentFileNumber].name);<br> &nbsp;}<br> &nbsp;else<br> &nbsp;{<br> &nbsp; &nbsp;// Create new zip file from modified files<br> &nbsp; &nbsp;zipArchiveToReadFrom.generateAsync({type:&quot;blob&quot;})<br> &nbsp; &nbsp;.then(function success(zippedFile) {<br> &nbsp; &nbsp; &nbsp;saveAs(zippedFile, &quot;resizedImages.zip&quot;);<br> &nbsp; &nbsp;},<br> &nbsp; &nbsp;function error(e) {<br> &nbsp; &nbsp; &nbsp;document.getElementById(&#39;archiveFileContents&#39;).innerHTML = &#39;&lt;br&gt;&lt;br&gt;&lt;b&gt;ERROR creating new zip file: &lt;/b&gt;:&#39; + e;<br> &nbsp; &nbsp; &nbsp;console.log(&#39;ERROR creating zip file:&#39; + e);<br> &nbsp; &nbsp;});<br> &nbsp;</span><span class="c11">}</span><span class="c8"><br>}<br></span></p><p class="c0 c5"><span class="c8"></span></p><p class="c1"><span class="c3">If the file we just processed is not the last file in the archive the next image file is set up to be processed using the chain of functions described above. Otherwise the zip archive is downloaded to the file resizedImages.zip.</span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1"><span class="c3">As you can see the code needed to do resizing of image files is pretty minimal. I am sure there could be some performance enhancements done, but is seems to process about an image per second and for my use that is plenty fast enough. Memory use might be a problem, although in resizing zip files with 200-300 images in them there have been no issues. </span></p><p class="c1 c5"><span class="c3"></span></p><p class="c1 c5"><span class="c2"></span></p><p class="c10"><span class="c2">Copyright 2018, Richard J. Moore</span></p><p class="c1 c5"><span class="c2"></span></p><p class="c1 c5"><span class="c2"></span></p><p class="c1"><span class="c2">keywords: Javascript, Image Resizing, JPEG, HTML5 Canvas</span></p><p class="c1"><span class="c2">description: Resizing of image files using a HTML5 Canvas in Javascript</span></p><p class="c1"><span class="c2">&nbsp;</span></p><p class="c1 c5"><span class="c2"></span></p>

<script>addHTMLCommentBox();</script>

</body></html>